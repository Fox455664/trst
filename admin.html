<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ù„Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{
  --blue:#005a8f;
  --orange:#f28b00;
  --bg:#f1f5f9;
  --card:#fff;
  --hover:#f8fafc;
}
*{box-sizing:border-box;font-family:'Cairo',sans-serif;margin:0;padding:0}
body{background:var(--bg);color:#111}

.admin-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 20px;background:var(--card);
  box-shadow:0 2px 10px rgba(0,0,0,0.1);border-bottom:5px solid var(--orange);
  position:sticky;top:0;z-index:1000;border-radius:0 0 12px 12px
}
.admin-header img{height:45px;border-radius:8px}
.header-left-box{
  border:2px solid var(--blue);padding:5px 10px;border-radius:8px;
  text-align:center;font-size:11px;color:var(--blue);background:#f9fafb
}
.btn{padding:8px 15px;border-radius:8px;border:none;cursor:pointer;font-weight:bold;font-size:13px}
.btn-del{background:#fee2e2;color:#b91c1c}
.btn-save{background:var(--blue);color:#fff}

.tabs{
  display:flex;gap:10px;padding:15px 20px;max-width:1200px;margin:auto
}
.tab-btn{
  flex:1;padding:12px;border-radius:10px;border:1px solid #ddd;
  font-weight:bold;background:var(--card);color:var(--blue);cursor:pointer;
  transition:.3s
}
.tab-btn.active{background:var(--blue);color:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.1)}

.container{max-width:1200px;margin:auto;padding:20px}

.card{
  background:var(--card);padding:20px;border-radius:15px;
  margin-bottom:25px;box-shadow:0 5px 15px rgba(0,0,0,0.05);
  transition:.3s;border-right:6px solid var(--blue)
}
.card:hover{background:var(--hover)}

.search-box{
  width:100%;padding:12px 15px;border-radius:12px;border:2px solid #ddd;margin-bottom:15px
}

.user-row{
  display:flex;justify-content:space-between;align-items:center;
  padding:10px;border-bottom:1px solid #eee;background:var(--card);
  border-radius:8px;margin-bottom:8px
}
.user-row:hover{background:var(--hover)}
.input-group{position:relative;margin-top:6px}
.input-group input{width:180px;padding:10px 35px 10px 10px;border-radius:8px;border:1px solid #ddd;background:#f9fafb}
.toggle-password{position:absolute;left:10px;top:50%;transform:translateY(-50%);cursor:pointer;color:#555}

.report-card{margin-bottom:12px;padding:12px;border-radius:12px;background:#fff;box-shadow:0 3px 8px rgba(0,0,0,0.05)}
.report-card:hover{background:#f8fafc}

@media print{.no-print{display:none}}
</style>
</head>
<body>

<div class="admin-header">
  <div style="display:flex;align-items:center;gap:10px">
    <img src="imeg/imge.jpg">
    <b style="color:var(--blue)">Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© ÙˆØ§Ù„Ø£Ø±Ø´ÙØ©</b>
  </div>
  <div class="header-left-box">Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø©<br>Ø¥Ø¯Ø§Ø±Ø© Ø¶ÙˆØ§Ø­ÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶</div>
  <button class="btn btn-del" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
</div>

<div class="tabs">
  <button class="tab-btn active" id="tR" onclick="showTab('reps')">ğŸ“‹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
  <button class="tab-btn" id="tU" onclick="showTab('users')">ğŸ‘¥ Ø§Ù„Ù…ÙØªØ´ÙŠÙ†</button>
</div>

<div class="container">

<!-- Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
<div id="viewReps">
  <div style="margin-bottom:10px;">
    <button class="btn btn-save" onclick="printReports()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF</button>
    <button class="btn btn-del" onclick="deleteAllReports()">ğŸ§¹ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
  </div>
  <input id="searchInput" class="search-box" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…ÙØªØ´ Ø£Ùˆ Ø§Ù„Ù…ÙˆÙ‚Ø¹..." oninput="runSearch()">
  <div id="reportsList">ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±...</div>
</div>

<!-- Ø§Ù„Ù…ÙØªØ´ÙŠÙ† -->
<div id="viewUsers" style="display:none">

<div class="card">
<h3>â• Ø¥Ø¶Ø§ÙØ© Ù…ÙØªØ´ Ø¬Ø¯ÙŠØ¯</h3>
<input id="newUser" class="search-box" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙØªØ´">
<input id="newPass" class="search-box" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" type="password">
<button class="btn btn-save" onclick="addInspector()">Ø­ÙØ¸ Ø§Ù„Ù…ÙØªØ´</button>
</div>

<div class="card">
<h3>ğŸ” ÙÙ„ØªØ± Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ÙØªØ´</h3>
<input id="filterInspector" class="search-box" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙØªØ´" oninput="filterInspectors()">
</div>

<div class="card">
<h3>ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØªØ´ÙŠÙ†</h3>
<div id="usersList">ØªØ­Ù…ÙŠÙ„...</div>
</div>

</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const REDIS_URL="https://exact-parakeet-58043.upstash.io";
const TOKEN="AeK7AAIncDFmOTAzMGJlOTM5Y2I0ZTFjYTg4ODRhOWIyNjJmZWMwY3AxNTgwNDM";

function showTab(tab){
  viewReps.style.display=tab==="reps"?"block":"none";
  viewUsers.style.display=tab==="users"?"block":"none";
  tR.classList.toggle("active",tab==="reps");
  tU.classList.toggle("active",tab==="users");
  if(tab==="users") loadUsers(); else fetchReports();
}

// Ø¥Ø¶Ø§ÙØ© Ù…ÙØªØ´
async function addInspector(){
  const u=newUser.value.trim();
  const p=newPass.value.trim();
  if(!u||!p) return alert("Ø§Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±");
  await fetch(`${REDIS_URL}/set/user:${u}`,{
    method:"POST",headers:{Authorization:`Bearer ${TOKEN}`},body:p
  });
  newUser.value=""; newPass.value="";
  alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙØªØ´ âœ…");
  loadUsers();
}

// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙØªØ´ÙŠÙ†
let allUsers=[];
async function loadUsers(){
  usersList.innerHTML="ØªØ­Ù…ÙŠÙ„...";
  const res=await fetch(`${REDIS_URL}/keys/user:*`,{headers:{Authorization:`Bearer ${TOKEN}`}});
  const keys=(await res.json()).result||[];
  allUsers=[];
  for(let k of keys){
    const name=k.split(":")[1];
    const r=await fetch(`${REDIS_URL}/get/${k}`,{headers:{Authorization:`Bearer ${TOKEN}`}});
    const pass=(await r.json()).result||"";
    allUsers.push({name,pass});
  }
  displayUsers(allUsers);
}

function displayUsers(list){
  usersList.innerHTML="";
  list.forEach(u=>{
    usersList.innerHTML+=`
    <div class="user-row">
      <div>
        <b>ğŸ‘¤ ${u.name}</b>
        <div class="input-group">
          <input type="password" id="p_${u.name}" value="${u.pass}">
          <i class="fa fa-eye toggle-password" onclick="togglePass('p_${u.name}',this)"></i>
        </div>
        <button class="btn btn-save" onclick="updatePass('${u.name}')">ğŸ’¾ ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</button>
      </div>
      <button class="btn btn-del" onclick="delUser('user:${u.name}')">Ø­Ø°Ù</button>
    </div>`;
  });
}

// ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ÙØªØ´ÙŠÙ†
function filterInspectors(){
  const term=filterInspector.value.toLowerCase();
  const filtered=allUsers.filter(u=>u.name.toLowerCase().includes(term));
  displayUsers(filtered);
}

// ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
async function updatePass(name){
  const val=document.getElementById(`p_${name}`).value.trim();
  if(!val) return alert("Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Ø¬Ø¯ÙŠØ¯Ø©");
  await fetch(`${REDIS_URL}/set/user:${name}`,{method:"POST",headers:{Authorization:`Bearer ${TOKEN}`},body:val});
  alert("ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± âœ…");
  loadUsers();
}

// Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯
function togglePass(id,icon){
  const inp=document.getElementById(id);
  if(inp.type==="password"){inp.type="text";icon.classList.replace("fa-eye","fa-eye-slash");}
  else{inp.type="password";icon.classList.replace("fa-eye-slash","fa-eye");}
}

// Ø­Ø°Ù Ù…ÙØªØ´
async function delUser(key){
  if(confirm("Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")){
    await fetch(`${REDIS_URL}/del/${key}`,{method:"POST",headers:{Authorization:`Bearer ${TOKEN}`}});
    loadUsers();
  }
}

// Ø§Ù„Ø®Ø±ÙˆØ¬
function logout(){sessionStorage.clear();location.href="index.html"}

// Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
let allReports=[];
async function fetchReports(){
  reportsList.innerHTML="ØªØ­Ù…ÙŠÙ„...";
  const r=await fetch(`${REDIS_URL}/lrange/reports_list/0/-1`,{headers:{Authorization:`Bearer ${TOKEN}`}});
  const ids=(await r.json()).result||[];
  allReports=[];
  for(let id of ids){
    const d=await fetch(`${REDIS_URL}/get/report:${id}`,{headers:{Authorization:`Bearer ${TOKEN}`}});
    const j=await d.json();
    if(j.result) allReports.push(JSON.parse(j.result));
  }
  runSearch();
}

// ÙÙ„ØªØ± Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
function runSearch(){
  const t=searchInput.value.toLowerCase();
  reportsList.innerHTML="";
  allReports.filter(r=>
    (r.inspector||"").toLowerCase().includes(t)||
    (r.location||"").toLowerCase().includes(t)
  ).reverse().forEach(r=>{
    reportsList.innerHTML+=`
    <div class="report-card">
      <b>ğŸ“„ ØªÙ‚Ø±ÙŠØ± #${r.serial}</b><br>
      Ø§Ù„Ù…ÙØªØ´: ${r.inspector}<br>
      Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${r.location}
    </div>`;
  });
}

// Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
async function deleteAllReports(){
  if(confirm("Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")){
    const ids=allReports.map(r=>`report:${r.serial}`);
    for(let id of ids){
      await fetch(`${REDIS_URL}/del/${id}`,{method:"POST",headers:{Authorization:`Bearer ${TOKEN}`}});
    }
    await fetch(`${REDIS_URL}/del/reports_list`,{method:"POST",headers:{Authorization:`Bearer ${TOKEN}`}});
    fetchReports();
    alert("ØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± âœ…");
  }
}

// Ø·Ø¨Ø§Ø¹Ø© PDF
function printReports(){
  if(allReports.length===0){alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©"); return;}
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y=10;
  allReports.forEach(r=>{
    doc.text(`ØªÙ‚Ø±ÙŠØ± #${r.serial}`,10,y); y+=7;
    doc.text(`Ø§Ù„Ù…ÙØªØ´: ${r.inspector}`,10,y); y+=7;
    doc.text(`Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${r.location}`,10,y); y+=10;
  });
  doc.save("Reports.pdf");
}

fetchReports();
</script>
</body>
</html>

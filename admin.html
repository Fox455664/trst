 --- START OF FILE Trst-main/admin.html ---
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± - Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #0a2e38; --gold: #c19a6b; --bg: #f1f5f9; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); margin: 0; padding: 20px; }
        .header { background: var(--primary); color: white; padding: 20px; border-radius: 15px; text-align: center; border-bottom: 5px solid var(--gold); margin-bottom: 20px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 15px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; background: white; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; }
        .search-box { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid var(--primary); margin-bottom: 20px; outline: none; }
        .card { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-right: 5px solid var(--primary); }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 5px; margin-top: 10px; }
        .stat-item { padding: 4px; border-radius: 4px; font-size: 10px; text-align: center; color: white; }
        .safe { background: #22c55e; } .danger { background: #ef4444; } .na { background: #94a3b8; }
        .img-thumb { width: 120px; height: 120px; object-fit: cover; border-radius: 10px; cursor: pointer; border: 1px solid #ddd; margin-top: 5px; }
        #imgModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; }
        .btn { padding: 8px 15px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; margin-left: 5px; }
        .btn-del { background: #ef4444; color: white; }
        .btn-edit { background: #0078d4; color: white; }
        .violation-card { margin-top:10px; border-right:3px solid var(--gold); padding:10px; background:#fafafa; border-radius:5px; }
        @media print { .no-print { display: none !important; } .card { page-break-inside: avoid; border: 1px solid #ddd; } }
    </style>
</head>
<body>

<div id="imgModal" onclick="this.style.display='none'">
    <img id="modalImg" src="" style="max-width:90%; max-height:90%; border-radius:10px;">
</div>

<div class="header">
    <h1>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</h1>
</div>

<div class="tabs no-print">
    <button onclick="showTab('reps')" id="tR" class="tab-btn active">ğŸ“‹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
    <button onclick="showTab('users')" id="tU" class="tab-btn">ğŸ‘¥ Ø§Ù„Ù…ÙØªØ´ÙŠÙ†</button>
    <button onclick="logout()" class="tab-btn" style="background:#ef4444; color:white">ğŸšª Ø®Ø±ÙˆØ¬</button>
</div>

<div id="viewReps">
    <input type="text" id="searchInput" class="search-box no-print" placeholder="ğŸ” Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ (Ù…ÙØªØ´ØŒ Ø±Ù‚Ù… ØªÙ‚Ø±ÙŠØ±ØŒ Ù…ÙˆÙ‚Ø¹ØŒ Ù…Ù‡Ù…Ø©)..." oninput="runSearch()">
    
    <div class="no-print" style="margin-bottom:15px; text-align:right">
        <button class="btn btn-del" onclick="deleteAllReports()">Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ğŸ—‘ï¸</button>
    </div>

    <div id="reportsList">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
</div>

<div id="viewUsers" style="display:none">
    <div class="card no-print">
        <h3>â• Ø¥Ø¶Ø§ÙØ© Ù…ÙØªØ´ Ø¬Ø¯ÙŠØ¯</h3>
        <input type="text" id="nu" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙØªØ´" style="padding:10px; border-radius:5px; border:1px solid #ddd">
        <input type="text" id="np" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" style="padding:10px; border-radius:5px; border:1px solid #ddd">
        <button onclick="addUser()" class="btn" style="background:var(--primary); color:white">Ø¥Ø¶Ø§ÙØ© âœ…</button>
    </div>
    <div id="usersList"></div>
</div>

<script>
if(sessionStorage.getItem('isAdmin') !== 'true') window.location.href = 'index.html';
const REDIS_URL = "https://exact-parakeet-58043.upstash.io";
const REDIS_TOKEN = "AeK7AAIncDFmOTAzMGJlOTM5Y2I0ZTFjYTg4ODRhOWIyNjJmZWMwY3AxNTgwNDM";

let allReports = [];

function showTab(t) {
    document.getElementById('viewReps').style.display = t==='reps'?'block':'none';
    document.getElementById('viewUsers').style.display = t==='users'?'block':'none';
    document.getElementById('tR').className = t==='reps'?'tab-btn active':'tab-btn';
    document.getElementById('tU').className = t==='users'?'tab-btn active':'tab-btn';
    if(t==='users') loadUsers(); else fetchReports();
}

async function fetchReports() {
    try {
        const res = await fetch(`${REDIS_URL}/lrange/reports_list/0/-1`, { headers: { Authorization: `Bearer ${REDIS_TOKEN}` } });
        const ids = (await res.json()).result || [];
        allReports = [];
        for(let id of ids) {
            const rRes = await fetch(`${REDIS_URL}/get/report:${id}`, { headers: { Authorization: `Bearer ${REDIS_TOKEN}` } });
            const rJson = await rRes.json();
            if(rJson.result) allReports.push(JSON.parse(rJson.result));
        }
        runSearch();
    } catch(e) { document.getElementById('reportsList').innerHTML = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„"; }
}

function runSearch() {
    const term = document.getElementById('searchInput').value.toLowerCase();
    const filtered = allReports.filter(r => 
        (r.inspector || "").toLowerCase().includes(term) || 
        (r.serial || "").toString().includes(term) ||
        (r.location || "").toLowerCase().includes(term) ||
        (r.job_order || "").toLowerCase().includes(term)
    );
    const area = document.getElementById('reportsList'); area.innerHTML = "";
    filtered.reverse().forEach(r => {
        let statusHtml = "";
        // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ù€ 47 Ø¨Ù†Ø¯ (Ø£Ùˆ Ø­Ø³Ø¨ Ø·ÙˆÙ„ Ù…ØµÙÙˆÙØ© Ø§Ù„Ø£Ø¬ÙˆØ¨Ø©)
        Object.keys(r.answers).forEach(key => {
            let ans = r.answers[key];
            let cls = ans === 'Ù†Ø¹Ù…' ? 'safe' : (ans === 'Ù„Ø§' ? 'danger' : 'na');
            statusHtml += `<div class="stat-item ${cls}">Ø¨Ù†Ø¯ ${key}: ${ans}</div>`;
        });

        let vHtml = "";
        if(r.violations && r.violations.length > 0) {
            r.violations.forEach(v => {
                vHtml += `
                <div class="violation-card">
                    <b>Ø¨Ù†Ø¯ ${v.id}: ${v.q}</b> <span style="background:#eee; padding:2px 5px; border-radius:4px; font-size:12px">${v.ans || ""}</span><br>
                    <span style="color:#0a2e38">ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©: ${v.note || "Ù„Ø§ ØªÙˆØ¬Ø¯"}</span><br>
                    ${v.photo ? `<img src="${v.photo}" class="img-thumb" onclick="openImg(this.src)">` : ""}
                </div>`;
            });
        }

        area.innerHTML += `
            <div class="card">
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:5px">
                    <b>ğŸ“„ ØªÙ‚Ø±ÙŠØ± #${r.serial}</b><span>ğŸ•’ ${r.timestamp}</span>
                </div>
                <p>ğŸ‘· Ø§Ù„Ù…ÙØªØ´: <b>${r.inspector}</b> | ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${r.location} | ğŸ“„ Ø§Ù„Ù…Ù‡Ù…Ø©: ${r.job_order}</p>
                <details class="no-print"><summary style="cursor:pointer; color:var(--primary)">ğŸ‘ï¸ Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ù†ÙˆØ¯</summary>
                    <div class="status-grid">${statusHtml}</div></details>
                <div style="margin-top:10px">
                    <h4 style="margin-bottom:5px; border-bottom:1px solid #ddd">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</h4>
                    ${vHtml || "<p style='color:gray'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ùˆ ØµÙˆØ± Ù…Ø±ÙÙ‚Ø©</p>"}
                </div>
                <div class="no-print" style="margin-top:15px">
                    <button class="btn btn-edit" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø© ğŸ–¨ï¸</button>
                    <button class="btn btn-del" onclick="deleteRep('${r.serial}')">Ø­Ø°Ù ğŸ—‘ï¸</button>
                </div>
            </div>`;
    });
}

function openImg(s) { document.getElementById('modalImg').src = s; document.getElementById('imgModal').style.display = 'flex'; }
function logout() { sessionStorage.clear(); window.location.href='index.html'; }

async function deleteRep(id) {
    if(confirm("Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŸ")) {
        await fetch(`${REDIS_URL}/del/report:${id}`, { headers: { Authorization: `Bearer ${REDIS_TOKEN}` } });
        await fetch(`${REDIS_URL}/lrem/reports_list/0/${id}`, { method:'POST', headers: { Authorization: `Bearer ${REDIS_TOKEN}` } });
        fetchReports();
    }
}

async function deleteAllReports(){
    if(!confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹!")) return;
    try {
        const res = await fetch(`${REDIS_URL}/lrange/reports_list/0/-1`, { headers: { Authorization: `Bearer ${REDIS_TOKEN}` } });
        const ids = (await res.json()).result || [];
        for(let id of ids){ await fetch(`${REDIS_URL}/del/report:${id}`, { headers: { Authorization: `Bearer ${REDIS_TOKEN}` } }); }
        await fetch(`${REDIS_URL}/del/reports_list`, { method:'POST', headers: { Authorization: `Bearer ${REDIS_TOKEN}` } });
        alert("âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­");
        fetchReports();
    } catch(err){ alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±"); }
}

function togglePw(u, realPw) {
    const el = document.getElementById(`pw-${u}`);
    if(el.innerText === 'â€¢â€¢â€¢â€¢â€¢â€¢') el.innerText = realPw;
    else el.innerText = 'â€¢â€¢â€¢â€¢â€¢â€¢';
}

async function loadUsers() {
    const res = await fetch(`${REDIS_URL}/smembers/inspectors`, { headers: { Authorization: `Bearer ${REDIS_TOKEN}` } });
    const users = (await res.json()).result || [];
    const area = document.getElementById('usersList'); area.innerHTML = "";
    for(let u of users) {
        const pRes = await fetch(`${REDIS_URL}/get/user:${u}`, { headers: { Authorization: `Bearer ${REDIS_TOKEN}` } });
        const pData = await pRes.json();
        area.innerHTML += `
            <div class="card" style="display:flex; justify-content:space-between; align-items:center; border-right-color:var(--gold)">
                <span>ğŸ‘¤ Ø§Ù„Ù…ÙØªØ´: <b>${u}</b> | ğŸ”‘ Ø§Ù„Ø³Ø±: 
                    <b id="pw-${u}" style="color:blue">â€¢â€¢â€¢â€¢â€¢â€¢</b>
                    <button class="btn" style="padding:3px 6px; font-size:10px" onclick="togglePw('${u}','${pData.result}')">ğŸ‘ï¸</button>
                </span>
                <div>
                    <button class="btn btn-edit" onclick="editPass('${u}')">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø± ğŸ”‘</button>
                    <button class="btn btn-del" onclick="delUser('${u}')">Ø­Ø°Ù ğŸ—‘ï¸</button>
                </div>
            </div>`;
    }
}

async function editPass(u) {
    const np = prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù€ " + u);
    if(np) { await fetch(`${REDIS_URL}/set/user:${u}`, { method:'POST', headers: { Authorization: `Bearer ${REDIS_TOKEN}` }, body: np }); loadUsers(); }
}

async function addUser() {
    const u = document.getElementById('nu').value; const p = document.getElementById('np').value;
    if(!u || !p) return;
    await fetch(`${REDIS_URL}/set/user:${u}`, { method:'POST', headers: { Authorization: `Bearer ${REDIS_TOKEN}` }, body: p });
    await fetch(`${REDIS_URL}/sadd/inspectors`, { method:'POST', headers: { Authorization: `Bearer ${REDIS_TOKEN}` }, body: u });
    alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©"); loadUsers();
}

async function delUser(u) {
    if(confirm("Ø­Ø°Ù Ø§Ù„Ù…ÙØªØ´ØŸ")) {
        await fetch(`${REDIS_URL}/del/user:${u}`, { headers: { Authorization: `Bearer ${REDIS_TOKEN}` } });
        await fetch(`${REDIS_URL}/srem/inspectors`, { method:'POST', headers: { Authorization: `Bearer ${REDIS_TOKEN}` }, body: u });
        loadUsers();
    }
}

fetchReports();
</script>
</body>
</html>
